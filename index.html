<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®£æˆå…¬ä¼—å·è‡ªåŠ¨åŒ–å·¥å‚</title>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        (function() {
            const myConfig = {
                theme: {
                    extend: {
                        colors: {
                            brand: 'var(--w-accent-color)',
                            bg: 'var(--w-bg-color)',
                            surface: 'var(--w-surface-color)',
                            text: 'var(--w-text-color)',
                            'text-sec': 'var(--w-text-sec-color)',
                        },
                        boxShadow: {
                            'ios': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        }
                    }
                }
            };
            function applyTailwindConfig() {
                if (typeof tailwind !== 'undefined') {
                    tailwind.config = myConfig;
                }
            }
            if (typeof tailwind !== 'undefined') {
                applyTailwindConfig();
            } else {
                window.addEventListener('load', applyTailwindConfig);
                const checkInterval = setInterval(() => {
                    if (typeof tailwind !== 'undefined') {
                        applyTailwindConfig();
                        clearInterval(checkInterval);
                    }
                }, 100);
                setTimeout(() => clearInterval(checkInterval), 5000);
            }
        })();
    </script>

    <!-- Custom Styles -->
    <style>
        :root {
            /* Default Theme (Classic White) */
            --w-accent-color: #07c160; 
            --w-bg-color: #f3f4f6;
            --w-surface-color: #ffffff;
            --w-text-color: #1f2937;
            --w-text-sec-color: #6b7280;
            --w-border-color: #e5e7eb;
        }

        [data-theme="tech"] { --w-accent-color: #3b82f6; --w-bg-color: #0f172a; --w-surface-color: #1e293b; --w-text-color: #f1f5f9; --w-text-sec-color: #94a3b8; --w-border-color: #334155; }
        [data-theme="warm"] { --w-accent-color: #d97706; --w-bg-color: #fef3c7; --w-surface-color: #fffbeb; --w-text-color: #451a03; --w-text-sec-color: #92400e; --w-border-color: #fde68a; }
        [data-theme="dark"] { --w-accent-color: #8b5cf6; --w-bg-color: #18181b; --w-surface-color: #27272a; --w-text-color: #e4e4e7; --w-text-sec-color: #a1a1aa; --w-border-color: #3f3f46; }

        body {
            background-color: var(--w-bg-color);
            color: var(--w-text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .console-scroll::-webkit-scrollbar { width: 6px; }
        .console-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .console-scroll::-webkit-scrollbar-thumb { background: var(--w-accent-color); border-radius: 3px; }

        /* æ›´æ–° .wx-content ç›¸å…³æ ·å¼ */
        .wx-content { 
            font-size: 16px !important; 
            line-height: 1.75; 
            letter-spacing: 0.05em; 
            text-align: justify; 
            color: #333333; 
        }
        .wx-content p { 
            margin-bottom: 1.5em; 
            min-height: 1em; 
            font-size: 16px !important; 
        }
        .wx-content h2 { 
            font-size: 18px !important; 
            font-weight: bold; 
            border-left: 4px solid var(--w-accent-color); 
            padding-left: 10px; 
            margin-top: 2em; 
            margin-bottom: 1em; 
            line-height: 1.4; 
            color: #000; 
        }
        .wx-content blockquote { 
            background: #f7f7f7; 
            border-radius: 4px; 
            padding: 1em; 
            margin: 1.5em 0; 
            color: #666; 
            font-size: 16px !important; 
            border-left: 3px solid #ddd; 
        }
        .wx-content strong { 
            color: var(--w-accent-color); 
            font-weight: 700; 
        }
        .wx-content ul { 
            padding-left: 1em; 
            margin-bottom: 1.5em; 
        }
        .wx-content li { 
            list-style-type: disc; 
            margin-bottom: 0.5em; 
            color: #444; 
            font-size: 16px !important; 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* é‡æ–°ç”ŸæˆæŒ‰é’®åŠ¨ç”» */
        button[title*="é‡æ–°ç”Ÿæˆ"] {
            transition: all 0.2s ease;
            transform: scale(0.9);
        }

        button[title*="é‡æ–°ç”Ÿæˆ"]:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Constants ---
        const DEFAULT_API_KEY = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // --- 2. Utilities ---
        const fetchWithRetry = async (url, options = {}, logCallback, maxRetries = 5) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const waitTime = (attempt + 1) * 5000;
                        logCallback(`âš ï¸ è§¦å‘é™æµ (429)ï¼Œç­‰å¾… ${waitTime/1000}ç§’åç¬¬ ${attempt + 1} æ¬¡é‡è¯•...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        attempt++;
                        continue;
                    }
                    if (response.status >= 500) {
                        const waitTime = Math.pow(2, attempt) * 1000;
                        logCallback(`âš ï¸ æœåŠ¡å™¨ç¹å¿™ (${response.status})ï¼Œç­‰å¾… ${waitTime/1000}ç§’åç¬¬ ${attempt + 1} æ¬¡é‡è¯•...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        attempt++;
                        continue;
                    }
                    if (response.status >= 400 && response.status < 500) {
                        const errText = await response.text();
                        throw new Error(`è¯·æ±‚è¢«æ‹’ç» (${response.status}): ${errText}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const waitTime = Math.pow(2, attempt) * 1000;
                    logCallback(`âš ï¸ ç½‘ç»œé”™è¯¯ (${error.message})ï¼Œ${waitTime/1000}ç§’åé‡è¯•...`);
                    await new Promise(r => setTimeout(r, waitTime));
                    attempt++;
                }
            }
        };

        // --- 3. Icons ---
        const Icons = {
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Copy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Image: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Theme: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Key: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
            Cloud: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a3 3 0 0 1-3-3c0-1.7 1.3-3 3-3 0-1.4 0-2.8.3-4.1A6 6 0 0 1 12 5c2.9 0 5.4 2 6 4.9 2.5.3 4.5 2.5 4.5 5.1 0 2.8-2.2 5-5 5z"/></svg>,
            Refresh: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
        };

        // --- 4. Main Components ---

        const Toast = ({ message, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-2 animate-bounce">
                    <Icons.Check />
                    <span>{message}</span>
                </div>
            );
        };

        const App = () => {
            const [apiKey, setApiKey] = React.useState(() => localStorage.getItem('wechat_automator_api_key') || "");
            const [showCustomKey, setShowCustomKey] = React.useState(() => !localStorage.getItem('wechat_automator_api_key'));
            const [topic, setTopic] = React.useState("");
            const [logs, setLogs] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [article, setArticle] = React.useState(null); 
            // article: { titles: [], digest: '', sections: [], coverUrl, coverPrompt }
            const [currentTitleIndex, setCurrentTitleIndex] = React.useState(0);
            
            const [theme, setTheme] = React.useState('classic');
            const [toast, setToast] = React.useState({ show: false, msg: '' });

            const logsEndRef = React.useRef(null);
            const previewRef = React.useRef(null);

            React.useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);
            React.useEffect(() => { document.body.setAttribute('data-theme', theme); }, [theme]);
            React.useEffect(() => {
                if (apiKey) localStorage.setItem('wechat_automator_api_key', apiKey);
                else localStorage.removeItem('wechat_automator_api_key');
            }, [apiKey]);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                setLogs(prev => [...prev, `[${time}] ${msg}`]);
            };

            const showToast = (msg) => {
                setToast({ show: true, msg });
                setTimeout(() => setToast({ show: false, msg: '' }), 3000);
            };

            const cycleTitle = () => {
                if (article && article.titles.length > 0) {
                    setCurrentTitleIndex((prev) => (prev + 1) % article.titles.length);
                }
            };

            const copyDigest = async () => {
                if (article && article.digest) {
                    try {
                        await navigator.clipboard.writeText(article.digest);
                        showToast("æ‘˜è¦å·²å¤åˆ¶");
                    } catch (e) {
                        showToast("å¤åˆ¶å¤±è´¥");
                    }
                }
            };

            // æ”¹è¿›çš„å›¾ç‰‡ç”Ÿæˆæç¤ºè¯ - é¿å…å‡ºç°äººç‰©ç•¸å½¢ç­‰é—®é¢˜
            const generateImage = async (prompt, isCover = false) => {
                // å¢å¼ºæç¤ºè¯ï¼Œé¿å…äººç‰©ç•¸å½¢
                const safetyPrompt = prompt + 
                    ", high quality, 8k, realistic, detailed, photorealistic, professional photography, " +
                    "avoid distorted bodies, avoid facial deformities, avoid extra limbs, avoid multiple people in one image, " +
                    "beautiful composition, natural lighting, cinematic";
                
                const seed = Math.floor(Math.random() * 1000000);
                const width = isCover ? 1080 : 1280;
                const height = isCover ? 460 : 720; 
                
                // ä½¿ç”¨æ›´ç¨³å®šçš„å›¾åƒç”Ÿæˆå‚æ•°
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(safetyPrompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&model=flux&enhance=true&safe=true`;
                
                addLog(`ğŸ¨ å¼€å§‹ç»˜åˆ¶${isCover ? 'å°é¢' : 'æ’å›¾'}: ${prompt.substring(0, 20)}...`);
                try {
                    const res = await fetchWithRetry(url, {}, addLog);
                    if (!res.ok) throw new Error("Image fetch failed");
                    const blob = await res.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    addLog(`âœ… ${isCover ? 'å°é¢' : 'æ’å›¾'}ç»˜åˆ¶æˆåŠŸ`);
                    return objectUrl;
                } catch (e) {
                    addLog(`âŒ ç»˜å›¾å¤±è´¥ï¼Œä½¿ç”¨å ä½å›¾: ${e.message}`);
                    // ç”Ÿæˆä¸€ä¸ªç®€å•çš„å ä½å›¾
                    return `data:image/svg+xml;charset=UTF-8,%3Csvg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg"%3E%3Crect width="100%25" height="100%25" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="20" fill="%23999"%3Eç¾ä¸½å›¾åƒç”Ÿæˆä¸­...%3C/text%3E%3C/svg%3E`;
                }
            };

            // é‡æ–°ç”Ÿæˆå•å¼ å›¾ç‰‡
            const regenerateImage = async (sectionId, prompt, isCover = false) => {
                addLog(`ğŸ”„ é‡æ–°ç”Ÿæˆå›¾ç‰‡: ${prompt.substring(0, 20)}...`);
                
                setArticle(prev => ({
                    ...prev,
                    sections: prev.sections.map(s => 
                        s.id === sectionId ? { ...s, isLoading: true, url: null } : s
                    )
                }));
                
                try {
                    const imgUrl = await generateImage(prompt, isCover);
                    setArticle(prev => ({
                        ...prev,
                        sections: prev.sections.map(s => 
                            s.id === sectionId ? { ...s, url: imgUrl, isLoading: false } : s
                        )
                    }));
                    addLog(`âœ… å›¾ç‰‡é‡æ–°ç”ŸæˆæˆåŠŸ`);
                } catch (error) {
                    addLog(`âŒ é‡æ–°ç”Ÿæˆå¤±è´¥: ${error.message}`);
                    setArticle(prev => ({
                        ...prev,
                        sections: prev.sections.map(s => 
                            s.id === sectionId ? { ...s, isLoading: false } : s
                        )
                    }));
                }
            };

            // é‡æ–°ç”Ÿæˆå°é¢
            const regenerateCover = async () => {
                if (!article || !article.coverPrompt) return;
                addLog("ğŸ”„ é‡æ–°ç”Ÿæˆå°é¢...");
                
                setArticle(prev => ({ ...prev, coverUrl: null }));
                const coverUrl = await generateImage(article.coverPrompt, true);
                setArticle(prev => ({ ...prev, coverUrl }));
                addLog("âœ… å°é¢é‡æ–°ç”Ÿæˆå®Œæˆ");
            };

            const handleStart = async () => {
                if (!topic) return showToast("è¯·è¾“å…¥é€‰é¢˜");
                const currentKey = apiKey;
                if (!currentKey) {
                    setShowCustomKey(true);
                    return showToast("è¯·å…ˆé…ç½® API Key");
                }
                
                setLoading(true);
                setLogs([]);
                setArticle(null);
                setCurrentTitleIndex(0);
                addLog("ğŸš€ ä»»åŠ¡å¯åŠ¨...");

                try {
                    addLog("ğŸ§  Gemini æ­£åœ¨æ„æ€...");
                    
                    // æ›´æ–°ç³»ç»Ÿæç¤ºè¯ï¼ŒåŒ…å«æ‰€æœ‰æ–°è¦æ±‚
                    const systemPrompt = `
ä½ æ˜¯å®£æˆè€å¸ˆçš„å…¬ä¼—å·å†™ä½œåŠ©æ‰‹ï¼Œéœ€è¦åˆ›ä½œé«˜è´¨é‡çš„æƒ…æ„Ÿç±»ã€æˆé•¿ç±»æ–‡ç« ã€‚

ã€ä½œè€…ä¿¡æ¯ã€‘ï¼š
- ä½œè€…åç§°ï¼šå®£æˆ
- èº«ä»½å®šä½ï¼šäº²å¯†å…³ç³»æ²Ÿé€šæ•™ç»ƒã€æƒ…æ„Ÿç–—æ„ˆå¸ˆ
- ä¸ªäººå“ç‰Œï¼šå¸®åŠ©å­¦å‘˜è§£å†³ç¤¾æã€è‡ªå‘ã€ä¸æ•¢è¡¨è¾¾ã€äº²å¯†å…³ç³»éšœç¢é—®é¢˜
- è¯¾ç¨‹ï¼šäº²å¯†å…³ç³»æ²Ÿé€šç³»ç»Ÿå®æˆ˜è¯¾

ã€æ–‡ç« ç»“æ„è¦æ±‚ã€‘ï¼š
1. **æ ‡é¢˜æ ¼å¼**ï¼šæ‰€æœ‰æ ‡é¢˜å‰é¢å¿…é¡»åŠ ä¸Š"å®£æˆï¼š"ä½œä¸ºå‰ç¼€ï¼Œä¾‹å¦‚ï¼š"å®£æˆï¼šå¦‚ä½•ä»ç¤¾æåˆ°è‡ªä¿¡è¡¨è¾¾"
2. **å¼€å¤´æ ¼å¼**ï¼šæ–‡ç« å¿…é¡»ä»¥å›ºå®šå¼€å¤´ï¼š"å—¨ï¼Œäº²çˆ±çš„ï¼Œä½ å¥½ï¼Œæˆ‘æ˜¯å®£æˆã€‚"ç„¶åè‡ªç„¶è¿‡æ¸¡åˆ°æ­£æ–‡
3. **æ­£æ–‡è¦æ±‚**ï¼š
   - æ­£æ–‡å†…å®¹æ§åˆ¶åœ¨2500-3000å­—ä¹‹é—´ï¼Œæƒ…æ„ŸçœŸæŒšï¼Œæ•…äº‹æ€§å¼º
   - æ‰€æœ‰æ•…äº‹ä¸­çš„äººç‰©å¿…é¡»ä½¿ç”¨ä¸­æ–‡åŒ–åï¼Œå¦‚ï¼šææ˜ã€ç‹èŠ³ã€å¼ ä¼Ÿã€é™ˆé™ã€åˆ˜æ´‹ç­‰ï¼Œä¸¥ç¦ä½¿ç”¨å¤–å›½åå­—
   - ä½¿ç”¨çœŸå®å¯ä¿¡çš„ä¸­å›½æ–‡åŒ–èƒŒæ™¯å’Œåœºæ™¯
4. **å­—ä½“è¦æ±‚**ï¼š
   - æ­£æ–‡æ–‡å­—ä½¿ç”¨16px
   - å¼•ç”¨æ–‡å­—ä½¿ç”¨16px
   - æ ‡é¢˜ä½¿ç”¨18px
5. **ç»“å°¾æ ¼å¼**ï¼šæ–‡ç« ç»“å°¾å¿…é¡»è‡ªç„¶è¿‡æ¸¡åˆ°è¯¾ç¨‹æ¨å¹¿ï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
   - å…ˆæ€»ç»“æ–‡ç« æ ¸å¿ƒè§‚ç‚¹ï¼Œè‡ªç„¶å¼•å‡ºä¸è¯¾ç¨‹ç›¸å…³çš„å†…å®¹
   - ç»“åˆæœ¬æ–‡ä¸»é¢˜ï¼Œå¼•å‡ºï¼š"æ²Ÿé€šï¼Œä¸ä»…æ˜¯å‘å¤–è¯´è¯ï¼Œæ›´æ˜¯å‘å†…ç–—æ„ˆã€‚"
   - æ ¹æ®æ–‡ç« å†…å®¹ä¸ªæ€§åŒ–åœ°è¿‡æ¸¡åˆ°è¯¾ç¨‹é‚€è¯·
   - ä½¿ç”¨æ ‡å‡†çš„è¯¾ç¨‹æ¨å¹¿æ–‡æ¡ˆ

ã€æ‘˜è¦è¦æ±‚ã€‘ï¼š
æ‘˜è¦å¿…é¡»ç²¾ç®€åˆ°50-80å­—ï¼Œè¦å¸å¼•äººç‚¹å‡»ï¼Œçªå‡ºæ–‡ç« æ ¸å¿ƒä»·å€¼ã€‚

ã€å›¾ç‰‡è¦æ±‚ã€‘ï¼š
1. æ‰€æœ‰å›¾ç‰‡æç¤ºè¯å¿…é¡»æ˜¯è‹±æ–‡
2. å›¾ç‰‡å†…å®¹è¦æ±‚ï¼šé¿å…å‡ºç°ä¸¤ä¸ªç”·äººã€ä¸‰ä¸ªäººæˆ–å¤šäººåœºæ™¯ï¼Œé¿å…èº«ä½“æˆ–è‚¢ä½“ç•¸å½¢
3. å›¾ç‰‡é£æ ¼ï¼šæ¸©é¦¨ã€æ²»æ„ˆã€é«˜è´¨é‡æ‘„å½±ã€è‡ªç„¶é£æ™¯ã€æŠ½è±¡è‰ºæœ¯ã€å•äººç‰©ç‰¹å†™ï¼ˆå¦‚æœéœ€è¦äººç‰©ï¼‰
4. å°é¢å›¾ç‰‡ï¼šä¸æ–‡ç« ä¸»é¢˜ç›¸å…³çš„é«˜è´¨é‡å›¾ç‰‡

ã€ç»“å°¾è¯¾ç¨‹æ¨å¹¿è¦æ±‚ã€‘ï¼š
1. å¿…é¡»æ ¹æ®æ–‡ç« çš„å…·ä½“å†…å®¹æ¥è®¾è®¡å¼•æµæ–‡æ¡ˆ
2. å…ˆæ€»ç»“æ–‡ç« çš„æ ¸å¿ƒé—®é¢˜æˆ–ä¸»é¢˜ï¼ˆå¦‚ï¼šç¤¾æã€è‡ªå‘ã€æ²Ÿé€šéšœç¢ç­‰ï¼‰
3. ç„¶åè‡ªç„¶è¿‡æ¸¡åˆ°è¯¾ç¨‹å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜
4. æœ€åä½¿ç”¨æ ‡å‡†è¯¾ç¨‹ä¿¡æ¯ï¼Œä½†å‰é¢çš„è¿‡æ¸¡éƒ¨åˆ†å¿…é¡»ä¸ªæ€§åŒ–
5. ç¤ºä¾‹æ ¼å¼ï¼ˆæ ¹æ®å®é™…æ–‡ç« å†…å®¹è°ƒæ•´ï¼‰ï¼š
   
"æ­£å¦‚[æ–‡ç« ä¸»äººå…¬çš„åå­—]çš„æ•…äº‹æ‰€å±•ç°çš„ï¼Œ[æ–‡ç« æ ¸å¿ƒé—®é¢˜]å¾€å¾€æºäºæˆ‘ä»¬å†…å¿ƒæ·±å¤„çš„é‚£ä¸ª[å…·ä½“åŸå› ï¼Œå¦‚ï¼šå—ä¼¤çš„å°å­©/æœªè¢«çœ‹è§çš„æƒ…ç»ª]ã€‚

æ²Ÿé€šï¼Œä¸ä»…æ˜¯å‘å¤–è¯´è¯ï¼Œæ›´æ˜¯å‘å†…ç–—æ„ˆã€‚

å¦‚æœä½ æƒ³è§£å¼€é‚£ä¸ªå°å°ï¼Œå¦‚æœä½ æƒ³æŠŠæ›¾ç»çš„æ•æ„Ÿå˜æˆå¦‚ä»Šçš„å¤©èµ‹ã€‚

æˆ‘æ„¿æ„é™ªä½ ä¸€èµ·ã€‚

åœ¨æˆ‘çš„"äº²å¯†å…³ç³»æ²Ÿé€šç³»ç»Ÿå®æˆ˜è¯¾"é‡Œï¼Œæˆ‘ä»¬ä¸è°ˆç©ºæ´çš„ç†è®ºï¼Œæˆ‘ä»¬åªåšç”Ÿå‘½çš„"å›æº¯"ä¸"é‡å¡‘"ã€‚

æˆ‘æ˜¯å®£æˆã€‚

æˆ‘åœ¨é‚£ä¸ªå®‰å…¨æ¸©æš–çš„åœºåŸŸé‡Œï¼Œç­‰ç€æ‹¥æŠ±é‚£ä¸ªæƒ³è¯´è¯çš„ä½ ã€‚

ã€å®£æˆè€å¸ˆ Â· äº²å¯†å…³ç³»æ²Ÿé€šç³»ç»Ÿå®æˆ˜è¯¾ã€‘

è¿™æ˜¯ä¸€é—¨èƒ½å¸®ä½ "æ”¹å†™äººç”Ÿå‰§æœ¬"çš„è¯¾ç¨‹ã€‚
è§£å†³ç¤¾æã€è‡ªå‘ã€ä¸æ•¢è¡¨è¾¾ã€äº²å¯†å…³ç³»éšœç¢ã€‚

ğŸ‘‡ æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œæ·»åŠ æˆ‘çš„ä¸ªäººå¾®ä¿¡
å…³æ³¨åç»­å¼€è¯¾é€šçŸ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·ï¼ŒæŠŠé‚£ä¸ªå—å§”å±ˆçš„å­©å­æ¥å›å®¶ã€‚"

ã€æ’ç‰ˆæ ¼å¼è¦æ±‚ã€‘ï¼š
- æ­£æ–‡æ®µè½ï¼š<p style="font-size:16px;">...</p>
- å¼•ç”¨æ–‡å­—ï¼š<blockquote style="font-size:16px;">...</blockquote>
- äºŒçº§æ ‡é¢˜ï¼š<h2 style="font-size:18px;">...</h2>
- å¼ºè°ƒæ–‡å­—ï¼š<strong>...</strong>
- åˆ—è¡¨ï¼š<ul><li>...</li></ul>

ã€JSONæ ¼å¼ã€‘ï¼š
è¿”å›çº¯ JSONï¼ŒåŒ…å«ï¼š
- 'digest': string (50-80å­—æ‘˜è¦)
- 'titles': string[] (5ä¸ªçˆ†æ¬¾æ ‡é¢˜æ•°ç»„ï¼Œæ¯ä¸ªæ ‡é¢˜éƒ½å¿…é¡»ä»¥"å®£æˆï¼š"å¼€å¤´)
- 'coverPrompt': string (è‹±æ–‡å°é¢æç¤ºè¯ï¼Œé¿å…å¤šäººåœºæ™¯)
- 'sections': Array<{ type: 'text'|'image_prompt', content: string }>

æ³¨æ„ï¼š
1. æ–‡ç« å¼€å¤´å¿…é¡»åŒ…å«ï¼š"å—¨ï¼Œäº²çˆ±çš„ï¼Œä½ å¥½ï¼Œæˆ‘æ˜¯å®£æˆã€‚"
2. æ‰€æœ‰äººç‰©å¿…é¡»ä½¿ç”¨ä¸­æ–‡åŒ–å
3. ç»“å°¾å¼•æµå¿…é¡»ä¸æ–‡ç« å†…å®¹æ·±åº¦ç»“åˆ
`;

                    const response = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${currentKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Topic: ${topic}` }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        },
                        addLog
                    );

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text;
                    let parsedData = JSON.parse(resultText);

                    // ç¡®ä¿æ ‡é¢˜éƒ½æœ‰"å®£æˆï¼š"å‰ç¼€
                    if (parsedData.titles) {
                        parsedData.titles = parsedData.titles.map(title => {
                            if (!title.startsWith("å®£æˆï¼š")) {
                                return `å®£æˆï¼š${title}`;
                            }
                            return title;
                        });
                    }

                    // ç¡®ä¿æ‘˜è¦é•¿åº¦åœ¨50-80å­—
                    if (parsedData.digest) {
                        const digestLength = parsedData.digest.length;
                        if (digestLength < 50 || digestLength > 80) {
                            addLog("âš ï¸ æ‘˜è¦é•¿åº¦ä¸ç¬¦åˆè¦æ±‚ï¼ŒAIå°†è‡ªåŠ¨è°ƒæ•´");
                        }
                    }

                    // Data Cleaning - ç¡®ä¿å­—ä½“æ ·å¼æ­£ç¡®åº”ç”¨
                    if (parsedData.sections) {
                        parsedData.sections = parsedData.sections.map(section => {
                            if (section.type === 'text') {
                                let cleanContent = section.content;
                                
                                // æ›¿æ¢ markdown æ ¼å¼
                                cleanContent = cleanContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                
                                // å¤„ç†æ ‡é¢˜ - ç¡®ä¿ä½¿ç”¨18px
                                cleanContent = cleanContent.replace(/^##\s+(.*$)/gm, '<h2 style="font-size:18px; font-weight:bold; border-left:4px solid #07c160; padding-left:10px; margin-top:2em; margin-bottom:1em; line-height:1.4; color:#000;">$1</h2>');
                                
                                // å¤„ç†æ®µè½ - ç¡®ä¿ä½¿ç”¨16px
                                cleanContent = cleanContent.replace(/<p>/g, '<p style="font-size:16px; line-height:1.75; margin-bottom:1.5em; color:#333; text-align:justify;">');
                                
                                // å¤„ç†å¼•ç”¨ - ç¡®ä¿ä½¿ç”¨16px
                                cleanContent = cleanContent.replace(/<blockquote>/g, '<blockquote style="font-size:16px; background:#f7f7f7; border-left:4px solid #ddd; padding:1em; margin:1.5em 0; color:#666; border-radius:4px;">');
                                
                                // å¤„ç†åˆ—è¡¨
                                cleanContent = cleanContent.replace(/^\*\s+(.*$)/gm, '<ul><li style="font-size:16px; margin-bottom:0.5em;">$1</li></ul>');
                                
                                // ç¡®ä¿å¼€å¤´æœ‰æ ‡å‡†é—®å€™
                                if (!cleanContent.includes("å—¨ï¼Œäº²çˆ±çš„ï¼Œä½ å¥½ï¼Œæˆ‘æ˜¯å®£æˆã€‚")) {
                                    cleanContent = `å—¨ï¼Œäº²çˆ±çš„ï¼Œä½ å¥½ï¼Œæˆ‘æ˜¯å®£æˆã€‚<br><br>${cleanContent}`;
                                }
                                
                                return { ...section, content: cleanContent };
                            }
                            return section;
                        });
                    }

                    addLog("ğŸ“ å¤§çº²å·²ç”Ÿæˆï¼Œå‡†å¤‡æ¸²æŸ“...");
                    
                    const initialSections = parsedData.sections.map((s, i) => ({
                        ...s,
                        id: i,
                        isLoading: s.type === 'image_prompt',
                        url: null
                    }));

                    setArticle({
                        titles: parsedData.titles || ["å®£æˆï¼šé»˜è®¤æ ‡é¢˜"],
                        digest: parsedData.digest || "æš‚æ— æ‘˜è¦",
                        coverUrl: null,
                        coverPrompt: parsedData.coverPrompt,
                        sections: initialSections
                    });

                    // Sequential Image Gen
                    const coverUrl = await generateImage(parsedData.coverPrompt, true);
                    setArticle(prev => ({ ...prev, coverUrl }));
                    
                    for (let i = 0; i < initialSections.length; i++) {
                        const section = initialSections[i];
                        if (section.type === 'image_prompt') {
                            await new Promise(r => setTimeout(r, 1000));
                            const imgUrl = await generateImage(section.content, false);
                            setArticle(prev => ({
                                ...prev,
                                sections: prev.sections.map(s => s.id === section.id ? { ...s, url: imgUrl, isLoading: false } : s)
                            }));
                        }
                    }

                    addLog("âœ¨ å…¨éƒ¨ä»»åŠ¡å®Œæˆï¼");

                } catch (error) {
                    addLog(`âŒ è‡´å‘½é”™è¯¯: ${error.message}`);
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            const copyToWeChat = async () => {
                if (!previewRef.current) return;
                addLog("ğŸ“‹ æ­£åœ¨å¤„ç†å¯Œæ–‡æœ¬...");
                showToast("æ­£åœ¨å‡†å¤‡å›¾ç‰‡...");
                
                const clone = previewRef.current.cloneNode(true);
                
                // 1. ç§»é™¤æ‰€æœ‰é‡æ–°ç”ŸæˆæŒ‰é’®
                const regenButtons = clone.querySelectorAll('button[title*="é‡æ–°ç”Ÿæˆ"]');
                regenButtons.forEach(btn => btn.remove());
                
                // 2. ç§»é™¤ group ç±»åï¼ˆé¿å…æ‚¬åœæ ·å¼æ®‹ç•™ï¼‰
                const groups = clone.querySelectorAll('.group');
                groups.forEach(el => {
                    el.classList.remove('group');
                    el.classList.remove('relative'); // ç§»é™¤ç›¸å¯¹å®šä½
                });
                
                // 3. å¤„ç†å›¾ç‰‡ï¼ˆç§»é™¤ç›¸å¯¹å®šä½å®¹å™¨ï¼‰
                const imageContainers = clone.querySelectorAll('div.relative');
                imageContainers.forEach(container => {
                    const img = container.querySelector('img');
                    if (img) {
                        container.parentNode.replaceChild(img.cloneNode(true), container);
                    }
                });
                
                // 4. Base64 è½¬æ¢
                const images = clone.querySelectorAll('img');
                
                for (let img of images) {
                    try {
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                        img.src = base64;
                    } catch (e) {
                        console.warn('Image conversion failed', e);
                    }
                }

                // Inline Styles - ç¡®ä¿å­—ä½“æ ·å¼æ­£ç¡®
                const processStyles = (root) => {
                    const allElements = root.querySelectorAll('*');
                    const brandColor = '#07c160';
                    allElements.forEach(el => {
                        const tagName = el.tagName.toLowerCase();
                        el.removeAttribute('class');
                        
                        // ç»Ÿä¸€è®¾ç½®åŸºç¡€å­—ä½“
                        if (!el.style.fontSize) {
                            el.style.fontSize = '16px';
                        }
                        
                        if (tagName === 'p' && !el.hasAttribute('style')) {
                            el.style.marginBottom = '1.5em';
                            el.style.lineHeight = '1.75';
                            el.style.fontSize = '16px';
                            el.style.color = '#333333';
                            el.style.textAlign = 'justify';
                        }
                        if (tagName === 'h2') {
                            el.style.fontSize = '18px';
                            el.style.fontWeight = 'bold';
                            el.style.borderLeft = `4px solid ${brandColor}`;
                            el.style.paddingLeft = '10px';
                            el.style.marginTop = '2em';
                            el.style.marginBottom = '1em';
                            el.style.lineHeight = '1.4';
                            el.style.color = '#000000';
                        }
                        if (tagName === 'blockquote') {
                            el.style.background = '#f7f7f7';
                            el.style.borderLeft = '4px solid #dddddd';
                            el.style.padding = '1em';
                            el.style.margin = '1.5em 0';
                            el.style.color = '#666666';
                            el.style.fontSize = '16px'; // ç¡®ä¿å¼•ç”¨ä¹Ÿæ˜¯16px
                            el.style.borderRadius = '4px';
                        }
                        if (tagName === 'strong' || tagName === 'b') {
                            el.style.color = brandColor;
                            el.style.fontWeight = '700';
                        }
                        if (tagName === 'ul') { 
                            el.style.paddingLeft = '20px'; 
                            el.style.margin = '1em 0'; 
                        }
                        if (tagName === 'li') { 
                            el.style.marginBottom = '0.5em'; 
                            el.style.listStyleType = 'disc'; 
                            el.style.fontSize = '16px'; // åˆ—è¡¨é¡¹ä¹Ÿæ˜¯16px
                        }
                        if (tagName === 'img') {
                            el.style.maxWidth = '100%';
                            el.style.height = 'auto';
                            el.style.display = 'block';
                            el.style.margin = '10px auto';
                            el.style.borderRadius = '6px';
                            el.setAttribute('data-src', el.src); 
                        }
                    });
                    root.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif";
                    root.style.fontSize = '16px';
                    root.style.lineHeight = '1.75';
                    root.style.color = '#333333';
                };
                
                processStyles(clone);
                const htmlContent = clone.outerHTML;

                try {
                    const blobHtml = new Blob([htmlContent], { type: "text/html" });
                    const blobText = new Blob([clone.innerText], { type: "text/plain" });
                    const data = [new ClipboardItem({ "text/html": blobHtml, "text/plain": blobText })];
                    await navigator.clipboard.write(data);
                    showToast("å¤åˆ¶æˆåŠŸï¼");
                    addLog("âœ… å¯Œæ–‡æœ¬å·²å¤åˆ¶");
                } catch (err) {
                    addLog(`âš ï¸ å°è¯•å…¼å®¹æ¨¡å¼...`);
                    try {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        tempDiv.style.position = 'fixed';
                        tempDiv.style.left = '-9999px';
                        tempDiv.style.backgroundColor = 'white';
                        document.body.appendChild(tempDiv);
                        const range = document.createRange();
                        range.selectNodeContents(tempDiv);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        document.execCommand('copy');
                        document.body.removeChild(tempDiv);
                        selection.removeAllRanges();
                        showToast("å·²å¤åˆ¶ (å…¼å®¹æ¨¡å¼)");
                    } catch (e) {
                        showToast("å¤åˆ¶å¤±è´¥");
                    }
                }
            };

            // Fixed: Clone Node method for complete full-page screenshot
            const exportLongImage = async () => {
                if (!previewRef.current) return;
                addLog("ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå…¨é‡é•¿å›¾...");
                
                try {
                    const element = previewRef.current;
                    const clone = element.cloneNode(true);
                    
                    // ç§»é™¤é‡æ–°ç”ŸæˆæŒ‰é’®ï¼ˆé•¿å›¾å¯¼å‡ºä¹Ÿä¸åŒ…å«æŒ‰é’®ï¼‰
                    const regenButtons = clone.querySelectorAll('button[title*="é‡æ–°ç”Ÿæˆ"]');
                    regenButtons.forEach(btn => btn.remove());
                    
                    // Force clone to full height and visible
                    clone.style.position = 'fixed';
                    clone.style.left = '-9999px';
                    clone.style.top = '0';
                    clone.style.width = `${element.offsetWidth}px`;
                    clone.style.height = 'auto';
                    clone.style.overflow = 'visible';
                    clone.style.zIndex = '-1000';
                    
                    document.body.appendChild(clone);
                    
                    // Wait for render
                    await new Promise(r => setTimeout(r, 500));

                    const canvas = await html2canvas(clone, {
                        useCORS: true,
                        scale: 2,
                        backgroundColor: '#ffffff',
                        height: clone.scrollHeight, // Capture full height
                        windowHeight: clone.scrollHeight
                    });
                    
                    document.body.removeChild(clone);
                    
                    const link = document.createElement('a');
                    link.download = `å®£æˆå…¬ä¼—å·-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    addLog("âœ… é•¿å›¾å·²å¯¼å‡º");
                } catch (err) {
                    addLog(`âŒ å¯¼å‡ºå¤±è´¥: ${err.message}`);
                }
            };

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    <Toast message={toast.msg} show={toast.show} />

                    {/* Left Panel */}
                    <div className="w-[40%] h-full bg-surface border-r border-[var(--w-border-color)] flex flex-col p-6 shadow-xl z-10 overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-brand flex items-center gap-2">
                                <Icons.Settings /> å®£æˆå…¬ä¼—å·è‡ªåŠ¨åŒ–å·¥å‚
                            </h1>
                            <div className="flex gap-2">
                                {['classic', 'tech', 'warm', 'dark'].map(t => (
                                    <button 
                                        key={t}
                                        onClick={() => setTheme(t)}
                                        className={`w-6 h-6 rounded-full border border-gray-300 ${theme === t ? 'ring-2 ring-brand' : ''}`}
                                        style={{ backgroundColor: t === 'dark' ? '#333' : t === 'tech' ? '#eff6ff' : t === 'warm' ? '#fffbeb' : '#fff' }}
                                    />
                                ))}
                            </div>
                        </div>

                        <div className="space-y-4 mb-6">
                            <div className="bg-bg rounded-lg p-3 border border-[var(--w-border-color)]">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-sm">
                                        <div className={`w-2 h-2 rounded-full ${apiKey ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                        <span className="font-semibold text-text">{apiKey ? 'API å·²å°±ç»ª' : 'æœªé…ç½® API'}</span>
                                    </div>
                                    <button onClick={() => setShowCustomKey(!showCustomKey)} className="text-xs text-brand hover:underline">{showCustomKey ? 'æ”¶èµ·' : 'è®¾ç½®'}</button>
                                </div>
                                {showCustomKey && (
                                    <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full mt-2 p-2 rounded bg-white border text-xs outline-none" placeholder="è¾“å…¥ Gemini API Key" />
                                )}
                            </div>

                            <div>
                                <label className="text-xs font-semibold text-text-sec uppercase">æ ¸å¿ƒé€‰é¢˜</label>
                                <textarea value={topic} onChange={(e) => setTopic(e.target.value)} className="w-full mt-1 p-3 rounded-lg bg-bg border border-[var(--w-border-color)] text-text outline-none h-24" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•å…‹æœç¤¾äº¤ææƒ§ç—‡ï¼Œå»ºç«‹æ·±åº¦å…³ç³»..." />
                            </div>
                            
                            <button onClick={handleStart} disabled={loading} className={`w-full py-3 rounded-lg font-bold text-white flex justify-center items-center gap-2 ${loading ? 'bg-gray-400' : 'bg-brand'}`}>
                                {loading ? <span className="animate-spin">âŒ›</span> : <Icons.Play />}
                                {loading ? "æ­£åœ¨ç”Ÿäº§ä¸­..." : "å¼€å§‹ç”Ÿäº§"}
                            </button>
                        </div>

                        {/* Article Meta Info Area */}
                        {article && (
                            <div className="mb-6 space-y-4 animate-fade-in">
                                <div className="bg-bg p-3 rounded-lg border border-[var(--w-border-color)]">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs font-bold text-text-sec uppercase">å¤‡é€‰æ ‡é¢˜ (ç‚¹å‡»åº”ç”¨)</span>
                                    </div>
                                    <div className="space-y-1">
                                        {article.titles.map((t, idx) => (
                                            <div 
                                                key={idx} 
                                                onClick={() => setCurrentTitleIndex(idx)}
                                                className={`text-sm p-2 rounded cursor-pointer transition-colors ${currentTitleIndex === idx ? 'bg-brand text-white' : 'hover:bg-gray-200 text-text'}`}
                                            >
                                                {t}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-bg p-3 rounded-lg border border-[var(--w-border-color)]">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs font-bold text-text-sec uppercase">æ‘˜è¦ (50-80å­—)</span>
                                        <button onClick={copyDigest} className="text-xs text-brand hover:underline">å¤åˆ¶æ‘˜è¦</button>
                                    </div>
                                    <p className="text-sm text-text leading-relaxed">{article.digest}</p>
                                    <div className="text-xs text-text-sec mt-1">å­—æ•°: {article.digest?.length || 0} å­—</div>
                                </div>
                            </div>
                        )}

                        <div className="flex-1 bg-[#1e1e1e] rounded-xl p-4 overflow-hidden flex flex-col font-mono text-xs shadow-inner min-h-[150px]">
                            <div className="text-gray-400 border-b border-gray-700 pb-2 mb-2">SYSTEM_LOG</div>
                            <div className="flex-1 overflow-y-auto console-scroll space-y-1">
                                {logs.map((log, i) => <div key={i} className={log.includes('âŒ') ? 'text-red-400' : 'text-green-400'}>{log}</div>)}
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>

                    {/* Right Panel */}
                    <div className="w-[60%] h-full bg-bg relative flex flex-col items-center justify-center p-8">
                        <div className="w-[375px] h-[812px] bg-white rounded-[40px] shadow-ios border-[8px] border-gray-800 relative overflow-hidden flex flex-col">
                            {/* Status Bar */}
                            <div className="h-10 w-full bg-white flex justify-between items-end px-6 pb-2 text-[10px] font-bold text-black z-10 select-none">
                                <span>9:41</span><div className="flex gap-1"><span>ğŸ“¶</span><span>ğŸ”‹</span></div>
                            </div>

                            {/* Content */}
                            <div className="flex-1 overflow-y-auto no-scrollbar bg-white" ref={previewRef}>
                                {article ? (
                                    <>
                                        {/* å°é¢éƒ¨åˆ† */}
                                        <div className="w-full aspect-[2.35/1] bg-gray-200 relative overflow-hidden group">
                                            {article.coverUrl ? (
                                                <div className="relative group">
                                                    <img src={article.coverUrl} className="w-full h-full object-cover" alt="Cover" crossOrigin="anonymous" />
                                                    {/* å°é¢é‡æ–°ç”ŸæˆæŒ‰é’® */}
                                                    <button 
                                                        onClick={regenerateCover}
                                                        className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/60 hover:bg-black/80 text-white p-2 rounded-full"
                                                        title="é‡æ–°ç”Ÿæˆå°é¢"
                                                    >
                                                        <Icons.Refresh />
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-400 animate-pulse bg-gray-100">
                                                    <span className="text-xs">å°é¢ç»˜åˆ¶ä¸­...</span>
                                                </div>
                                            )}
                                            <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/70 to-transparent text-white">
                                                <div className="flex items-start gap-2">
                                                    <h1 className="text-lg font-bold leading-tight line-clamp-2 flex-1">{article.titles[currentTitleIndex]}</h1>
                                                    <button onClick={cycleTitle} className="mt-1 p-1 bg-white/20 rounded-full hover:bg-white/40 transition-colors" title="åˆ‡æ¢æ ‡é¢˜">
                                                        <Icons.Refresh />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="p-5 wx-content pb-20">
                                            {article.sections.map((section, idx) => {
                                                if (section.type === 'text') {
                                                    return <div key={idx} dangerouslySetInnerHTML={{ __html: section.content }} />;
                                                } else {
                                                    return (
                                                        <div key={idx} className="my-6 rounded-lg overflow-hidden shadow-sm relative group">
                                                            {section.url ? (
                                                                <div className="relative">
                                                                    <img src={section.url} className="w-full h-auto block" alt="AI Generated" crossOrigin="anonymous" />
                                                                    {/* é‡æ–°ç”ŸæˆæŒ‰é’® */}
                                                                    <button 
                                                                        onClick={() => regenerateImage(section.id, section.content, false)}
                                                                        className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/60 hover:bg-black/80 text-white p-2 rounded-full"
                                                                        title="é‡æ–°ç”Ÿæˆå›¾ç‰‡"
                                                                    >
                                                                        <Icons.Refresh />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <div className="w-full aspect-video bg-gray-50 flex flex-col items-center justify-center border-2 border-dashed border-gray-200 animate-pulse">
                                                                    {section.isLoading ? (
                                                                        <>
                                                                            <div className="w-8 h-8 border-4 border-brand border-t-transparent rounded-full animate-spin mb-2"></div>
                                                                            <span className="text-xs text-gray-500">å›¾ç‰‡ç”Ÿæˆä¸­...</span>
                                                                        </>
                                                                    ) : (
                                                                        <span className="text-xs text-gray-400">ç­‰å¾…ç”Ÿæˆå›¾ç‰‡</span>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                }
                                            })}
                                            <div className="mt-8 pt-8 border-t border-gray-100 text-center text-gray-400 text-xs">- End -</div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 space-y-4">
                                        <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-2"><Icons.Settings /></div>
                                        <p>ç­‰å¾…å†…å®¹ç”Ÿæˆ...</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Actions */}
                        {article && !loading && (
                            <div className="absolute bottom-8 right-12 flex flex-col gap-4">
                                <button onClick={copyToWeChat} className="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-green-600 hover:scale-110 transition-transform group border border-gray-100" title="å¤åˆ¶åˆ°å¾®ä¿¡">
                                    <Icons.Copy />
                                </button>
                                <button onClick={exportLongImage} className="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-blue-600 hover:scale-110 transition-transform group border border-gray-100" title="å¯¼å‡ºé•¿å›¾">
                                    <Icons.Image />
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>